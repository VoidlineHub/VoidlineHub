-- [[ 1. INITIALIZATION ]] --
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local PlayerGui = LP:WaitForChild("PlayerGui")

-- // WindUI Initialization
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

-- // Global Variables
_G.AutoFarmBarista = false
_G.AntiAFK = true

-- // STATE
local StartTime = os.time()
local TotalEarned = 0
local LastMoney = 0
local isWorking = false
local BaristaRunning = false

-- // PLAYER DATA
local PlayerData = LP:WaitForChild("PlayerData")
local MoneyValue = PlayerData:WaitForChild("RPValue")
LastMoney = MoneyValue.Value

MoneyValue:GetPropertyChangedSignal("Value"):Connect(function()
    local diff = MoneyValue.Value - LastMoney
    if diff > 0 then TotalEarned = TotalEarned + diff end
    LastMoney = MoneyValue.Value
end)

-- // WINDOW
local Window = WindUI:CreateWindow({
    Title = "VoidlineHub | Barista",
    Folder = "voidline_barista",
    Icon = "rbxassetid://124846601689213",
    NewElements = true,
    Size = UDim2.fromOffset(300, 350),
    OpenButton = { Title = "Voidline", Enabled = true, Draggable = true },
    Topbar = { Height = 44, ButtonsType = "Mac" },
})

-- // TAB: HOME
local HomeTab = Window:Tab({ Title = "Home", Icon = "house" })
HomeTab:Section({ Title = "Statistics" })
local StatusLabel = HomeTab:Button({ Title = "Status", Desc = "Idle", Icon = "activity" })
local IncomeLabel = HomeTab:Button({ Title = "Total Earned", Desc = "Rp0", Icon = "wallet" })

-- // TAB: AUTO FARM
local AutoFarmTab = Window:Tab({ Title = "Auto Farm", Icon = "car" })
AutoFarmTab:Section({ Title = "Barista Job" })
AutoFarmTab:Toggle({
    Title = "Auto Barista",
    Value = false,
    Callback = function(v)
        _G.AutoFarmBarista = v
        if StatusLabel and StatusLabel.Set then
            StatusLabel:Set({ Desc = v and "Farming..." or "Stopped" })
        end
    end
})

-- // BARISTA LOGIC
local POS_EXIT_BARISTA = Vector3.new(-5004.42, 2.89, -678.09)
local POS_SUPPLY = Vector3.new(-5114.04, 2.89, -669.93)
local BaristaJob = workspace:WaitForChild("BaristaJob")
local Interactions = BaristaJob:WaitForChild("Interactions")
local machinePart = Interactions.MachinePart.MachinePart
local registerPart = Interactions.RegisterPart.RegisterPart
local supplyPart = Interactions.SupplyPart.SupplyPart

local function getHRP() return LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") end

local function autoWalk(targetPos)
    local hum = LP.Character and LP.Character:FindFirstChild("Humanoid")
    local hrp = getHRP()
    if not hum or not hrp then return end
    hum.WalkSpeed = 30
    local lastPos = hrp.Position
    local stuckTick = 0
    repeat
        if not _G.AutoFarmBarista then break end
        hum:MoveTo(targetPos)
        task.wait(0.2)
        if (hrp.Position - lastPos).Magnitude < 0.5 then
            stuckTick = stuckTick + 1
            if stuckTick >= 4 then hum.Jump = true stuckTick = 0 end
        else stuckTick = 0 end
        lastPos = hrp.Position
    until (hrp.Position - targetPos).Magnitude < 4.5 -- Magnitude lebih longgar biar gak stuck
end

local function holdClick(prompt)
    if not prompt then return end
    -- Force enable check
    local t = 0
    while not prompt.Enabled and t < 10 do
        task.wait(0.1)
        t = t + 1
    end
    task.wait(0.3)
    prompt:InputHoldBegin()
    task.wait((prompt.HoldDuration > 0 and prompt.HoldDuration or 0.3) + 0.2)
    prompt:InputHoldEnd()
    fireproximityprompt(prompt)
    task.wait(0.3)
end

local function runRepairFlow()
    isWorking = true
    autoWalk(POS_EXIT_BARISTA)
    autoWalk(POS_SUPPLY)
    holdClick(supplyPart:FindFirstChild("SupplyPrompt"))
    task.wait(1.5)
    autoWalk(POS_EXIT_BARISTA)
    autoWalk(machinePart.Position)
    isWorking = false
end

local function handleMinigame()
    local gui = PlayerGui:FindFirstChild("BaristaGUI")
    local mini = gui and gui:FindFirstChild("MinigameFrame")
    if not mini or not mini.Visible then return end
    isWorking = true
    pcall(function()
        local target = mini.BackgroundBar.TargetZone
        target.Size = UDim2.new(1, 0, 1, 0)
        target.Position = UDim2.new(-1, 0, -1, 0)
        target.Transparency  = 1
    end)
    while mini.Visible and _G.AutoFarmBarista do task.wait(0.5) end
    task.wait(0.5)
    autoWalk(registerPart.Position)
    holdClick(registerPart:FindFirstChild("RegisterPrompt"))
    autoWalk(machinePart.Position)
    isWorking = false
end

local function StartBaristaGhost()
    if BaristaRunning then return end
    BaristaRunning = true
    task.spawn(function()
        while _G.AutoFarmBarista do
            local missionUI = PlayerGui:FindFirstChild("BaristaMissionUI")
            if missionUI then
                local label = missionUI:FindFirstChild("ObjectiveLabel", true)
                if label and label.TextColor3 == Color3.fromRGB(255, 50, 50) then
                    runRepairFlow()
                end
            end
            if missionUI and not isWorking then
                local gui = PlayerGui:FindFirstChild("BaristaGUI")
                local mini = gui and gui:FindFirstChild("MinigameFrame")
                if mini and mini.Visible then handleMinigame() else
                    local dist = (getHRP().Position - machinePart.Position).Magnitude
                    if dist > 6 then -- Jarak deteksi mesin diperluas
                        autoWalk(machinePart.Position)
                    else
                        holdClick(machinePart:FindFirstChild("MachinePrompt"))
                    end
                end
            end
            task.wait(0.5)
        end
        BaristaRunning = false
    end)
end

-- // INFO LOOP
task.spawn(function()
    while true do
        task.wait(1)
        pcall(function()
            if IncomeLabel and IncomeLabel.Set then
                IncomeLabel:Set({ Desc = "Rp " .. tostring(TotalEarned) })
            end
        end)
        if _G.AutoFarmBarista then StartBaristaGhost() end
    end
end)
